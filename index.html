<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>arXiv论文搜索系统</title>
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Element Plus -->
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css">
    <script src="https://unpkg.com/element-plus"></script>
    <!-- Axios -->
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        /* 头部 */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px 20px;
            text-align: center;
            margin-bottom: 30px;
            border-radius: 0 0 20px 20px;
        }
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }
        /* 搜索区 */
        .search-section {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            margin-bottom: 25px;
        }
        .search-box {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        .search-box .el-input {
            flex: 1;
        }
        .filters {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        .filters .el-select {
            width: 150px;
        }
        /* 统计卡片 */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            text-align: center;
        }
        .stat-card .number {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }
        .stat-card .label {
            color: #909399;
            margin-top: 5px;
        }
        /* 主题标签 */
        .topics-section {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            margin-bottom: 25px;
        }
        .topics-section h3 {
            margin-bottom: 15px;
            color: #303133;
        }
        .topic-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .topic-tag {
            padding: 8px 16px;
            background: #f0f2f5;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }
        .topic-tag:hover {
            background: #667eea;
            color: white;
        }
        .topic-tag.active {
            background: #667eea;
            color: white;
        }
        .topic-tag .count {
            margin-left: 5px;
            opacity: 0.7;
            font-size: 12px;
        }
        /* 结果区 */
        .results-section {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        }
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        .results-header h3 {
            color: #303133;
        }
        /* 论文卡片 */
        .paper-card {
            padding: 20px;
            border: 1px solid #ebeef5;
            border-radius: 8px;
            margin-bottom: 15px;
            transition: all 0.3s;
        }
        .paper-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-color: #667eea;
        }
        .paper-title {
            font-size: 1.1em;
            font-weight: 600;
            color: #303133;
            margin-bottom: 10px;
            cursor: pointer;
        }
        .paper-title:hover {
            color: #667eea;
        }
        .paper-title mark {
            background: #fff3cd;
            padding: 0 2px;
        }
        .paper-meta {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
            font-size: 13px;
            color: #909399;
        }
        .paper-meta span {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .paper-abstract {
            color: #606266;
            font-size: 14px;
            line-height: 1.6;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .paper-abstract mark {
            background: #fff3cd;
            padding: 0 2px;
        }
        .paper-tags {
            margin-top: 12px;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        /* 分页 */
        .pagination {
            margin-top: 25px;
            display: flex;
            justify-content: center;
        }
        /* 详情弹窗 */
        .detail-section {
            margin-bottom: 20px;
        }
        .detail-section h4 {
            color: #909399;
            font-size: 13px;
            margin-bottom: 8px;
        }
        .detail-section p {
            color: #303133;
            line-height: 1.8;
        }
        .detail-authors {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        /* 空状态 */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #909399;
        }
        .empty-state .icon {
            font-size: 60px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- 头部 -->
        <div class="header">
            <h1>arXiv论文搜索系统</h1>
            <p>基于Elasticsearch的学术论文智能检索平台</p>
        </div>

        <div class="container">
            <!-- 统计卡片 -->
            <div class="stats-row">
                <div class="stat-card">
                    <div class="number">{{ stats.total_papers || 0 }}</div>
                    <div class="label">论文总数</div>
                </div>
                <div class="stat-card">
                    <div class="number">{{ stats.categories?.length || 0 }}</div>
                    <div class="label">类别数量</div>
                </div>
                <div class="stat-card">
                    <div class="number">{{ topics.length }}</div>
                    <div class="label">主题数量</div>
                </div>
                <div class="stat-card">
                    <div class="number">{{ searchResult.total || 0 }}</div>
                    <div class="label">搜索结果</div>
                </div>
            </div>

            <!-- 搜索区 -->
            <div class="search-section">
                <div class="search-box">
                    <el-input
                        v-model="searchQuery"
                        placeholder="输入关键词搜索论文..."
                        size="large"
                        clearable
                        @keyup.enter="doSearch"
                    >
                        <template #prefix>
                            <span>&#128269;</span>
                        </template>
                    </el-input>
                    <el-button type="primary" size="large" @click="doSearch">
                        搜索
                    </el-button>
                </div>
                <div class="filters">
                    <el-select v-model="filters.category" placeholder="类别" clearable @change="doSearch">
                        <el-option
                            v-for="cat in stats.categories"
                            :key="cat.name"
                            :label="cat.name + ' (' + cat.count + ')'"
                            :value="cat.name"
                        />
                    </el-select>
                    <el-select v-model="filters.year" placeholder="年份" clearable @change="doSearch">
                        <el-option
                            v-for="y in stats.years"
                            :key="y.year"
                            :label="y.year + '年 (' + y.count + ')'"
                            :value="y.year"
                        />
                    </el-select>
                    <el-select v-model="filters.sort" placeholder="排序" @change="doSearch">
                        <el-option label="相关度" value="relevance" />
                        <el-option label="最新优先" value="newest" />
                        <el-option label="最早优先" value="oldest" />
                    </el-select>
                    <el-button @click="resetFilters">重置</el-button>
                </div>
            </div>

            <!-- 主题标签 -->
            <div class="topics-section">
                <h3>主题浏览</h3>
                <div class="topic-tags">
                    <div
                        v-for="topic in topics"
                        :key="topic.topic_id"
                        class="topic-tag"
                        :class="{ active: filters.topic === topic.topic_id }"
                        @click="selectTopic(topic.topic_id)"
                    >
                        {{ getTopicLabel(topic) }}
                        <span class="count">({{ topic.paper_count }})</span>
                    </div>
                </div>
            </div>

            <!-- 搜索结果 -->
            <div class="results-section">
                <div class="results-header">
                    <h3>搜索结果</h3>
                    <span style="color: #909399;">
                        共 {{ searchResult.total }} 条，第 {{ searchResult.page }}/{{ searchResult.pages }} 页
                    </span>
                </div>

                <!-- 加载中 -->
                <div v-if="loading" style="text-align: center; padding: 40px;">
                    <el-icon class="is-loading" style="font-size: 30px; color: #667eea;">
                        <span>&#8635;</span>
                    </el-icon>
                    <p style="margin-top: 10px; color: #909399;">搜索中...</p>
                </div>

                <!-- 空状态 -->
                <div v-else-if="searchResult.results.length === 0" class="empty-state">
                    <div class="icon">&#128196;</div>
                    <p>暂无搜索结果</p>
                    <p style="font-size: 14px; margin-top: 10px;">试试其他关键词或调整筛选条件</p>
                </div>

                <!-- 论文列表 -->
                <div v-else>
                    <div
                        v-for="paper in searchResult.results"
                        :key="paper.arxiv_id"
                        class="paper-card"
                    >
                        <div
                            class="paper-title"
                            @click="showDetail(paper.arxiv_id)"
                            v-html="paper.highlight?.title || paper.title"
                        ></div>
                        <div class="paper-meta">
                            <span>ID: {{ paper.arxiv_id }}</span>
                            <span>年份: {{ paper.year || '-' }}</span>
                            <span>相关度: {{ paper.score?.toFixed(2) || '-' }}</span>
                            <span v-if="paper.topic_id !== null">主题: {{ paper.topic_id }}</span>
                        </div>
                        <div
                            class="paper-abstract"
                            v-html="paper.highlight?.abstract || paper.abstract"
                        ></div>
                        <div class="paper-tags">
                            <el-tag
                                v-for="cat in paper.categories?.slice(0, 3)"
                                :key="cat"
                                size="small"
                                type="info"
                            >
                                {{ cat }}
                            </el-tag>
                        </div>
                    </div>

                    <!-- 分页 -->
                    <div class="pagination">
                        <el-pagination
                            v-model:current-page="currentPage"
                            :page-size="pageSize"
                            :total="searchResult.total"
                            layout="prev, pager, next, jumper"
                            @current-change="handlePageChange"
                        />
                    </div>
                </div>
            </div>
        </div>

        <!-- 论文详情弹窗 -->
        <el-dialog v-model="detailVisible" title="论文详情" width="700px">
            <div v-if="detailPaper">
                <div class="detail-section">
                    <h4>标题</h4>
                    <p style="font-size: 18px; font-weight: 600;">{{ detailPaper.title }}</p>
                </div>
                <div class="detail-section">
                    <h4>作者</h4>
                    <div class="detail-authors">
                        <el-tag v-for="author in detailPaper.authors" :key="author" size="small">
                            {{ author }}
                        </el-tag>
                    </div>
                </div>
                <div class="detail-section">
                    <h4>摘要</h4>
                    <p>{{ detailPaper.abstract }}</p>
                </div>
                <div class="detail-section">
                    <h4>元信息</h4>
                    <p>
                        <strong>arXiv ID:</strong> {{ detailPaper.arxiv_id }}<br>
                        <strong>发表时间:</strong> {{ detailPaper.published }}<br>
                        <strong>类别:</strong> {{ detailPaper.categories?.join(', ') }}<br>
                        <strong>主题ID:</strong> {{ detailPaper.topic_id }} 
                        (置信度: {{ (detailPaper.topic_probability * 100)?.toFixed(1) }}%)
                    </p>
                </div>
            </div>
            <template #footer>
                <el-button @click="detailVisible = false">关闭</el-button>
                <el-button type="primary" @click="openPDF">查看PDF</el-button>
            </template>
        </el-dialog>
    </div>

    <script>
        const { createApp, ref, reactive, onMounted } = Vue;

        const API_BASE = 'https://unmotionable-erick-nonhyperbolically.ngrok-free.dev/';

        createApp({
            setup() {
                // 状态
                const loading = ref(false);
                const searchQuery = ref('');
                const currentPage = ref(1);
                const pageSize = ref(10);
                
                const filters = reactive({
                    category: null,
                    year: null,
                    topic: null,
                    sort: 'relevance'
                });

                const stats = ref({});
                const topics = ref([]);
                const searchResult = ref({
                    total: 0,
                    page: 1,
                    pages: 0,
                    results: []
                });

                const detailVisible = ref(false);
                const detailPaper = ref(null);

                // 方法
                const fetchStats = async () => {
                    try {
                        const res = await axios.get(`${API_BASE}/stats`);
                        stats.value = res.data;
                    } catch (e) {
                        console.error('获取统计失败:', e);
                    }
                };

                const fetchTopics = async () => {
                    try {
                        const res = await axios.get(`${API_BASE}/topics`);
                        topics.value = res.data;
                    } catch (e) {
                        console.error('获取主题失败:', e);
                    }
                };

                const doSearch = async () => {
                    loading.value = true;
                    try {
                        const params = {
                            q: searchQuery.value,
                            page: currentPage.value,
                            size: pageSize.value,
                            sort: filters.sort
                        };
                        if (filters.category) params.category = filters.category;
                        if (filters.year) params.year_from = filters.year;
                        if (filters.year) params.year_to = filters.year;
                        if (filters.topic !== null) params.topic = filters.topic;

                        const res = await axios.get(`${API_BASE}/search`, { params });
                        searchResult.value = res.data;
                    } catch (e) {
                        console.error('搜索失败:', e);
                        ElementPlus.ElMessage.error('搜索失败，请检查后端服务');
                    } finally {
                        loading.value = false;
                    }
                };

                const handlePageChange = (page) => {
                    currentPage.value = page;
                    doSearch();
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                };

                const selectTopic = (topicId) => {
                    if (filters.topic === topicId) {
                        filters.topic = null;
                    } else {
                        filters.topic = topicId;
                    }
                    currentPage.value = 1;
                    doSearch();
                };

                const resetFilters = () => {
                    searchQuery.value = '';
                    filters.category = null;
                    filters.year = null;
                    filters.topic = null;
                    filters.sort = 'relevance';
                    currentPage.value = 1;
                    doSearch();
                };

                const getTopicLabel = (topic) => {
                    const keywords = topic.keywords?.slice(0, 3).map(k => k.word).join(', ');
                    return `#${topic.topic_id} ${keywords}`;
                };

                const showDetail = async (arxivId) => {
                    try {
                        const res = await axios.get(`${API_BASE}/paper/${arxivId}`);
                        detailPaper.value = res.data;
                        detailVisible.value = true;
                    } catch (e) {
                        ElementPlus.ElMessage.error('获取详情失败');
                    }
                };

                const openPDF = () => {
                    if (detailPaper.value?.pdf_url) {
                        window.open(detailPaper.value.pdf_url, '_blank');
                    }
                };

                // 初始化
                onMounted(() => {
                    fetchStats();
                    fetchTopics();
                    doSearch();
                });

                return {
                    loading,
                    searchQuery,
                    currentPage,
                    pageSize,
                    filters,
                    stats,
                    topics,
                    searchResult,
                    detailVisible,
                    detailPaper,
                    doSearch,
                    handlePageChange,
                    selectTopic,
                    resetFilters,
                    getTopicLabel,
                    showDetail,
                    openPDF
                };
            }
        }).use(ElementPlus).mount('#app');
    </script>
</body>
</html>
